<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script src="https://unpkg.com/vue@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-loading-overlay@5.0.3/dist/vue-loading.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/vue-loading-overlay@5.0.3/dist/vue-loading.css" rel="stylesheet">
    <title>Document</title>
    <style>
        .product-image{
            padding-bottom: 100%;
        }
    </style>
</head>
<body>
    <div id="app">
        <ul class="prolist flex flex-wrap max-w-screen-xl mx-auto">
            <li class="w-1/5 px-2 mb-4" v-for="product in productList" :key="product.id">
                <div class="p-3 bg-gray-200">
                    <div class="product-image w-full bg-cover" :style="{backgroundImage:`url( ${product.imageUrl} )`}"></div>
                    <p class="font-bold text-gray-700 text-xl py-3">{{ product.title }}</p>
                    <div class="flex justify-between">
                        <button type="button" class="bg-gray-500  text-white focus:ring-4 focus:ring-gray-300 rounded border border-gray-200 text-sm font-bold px-4 py-2 focus:z-10  hover:bg-gray-600 disabled:opacity-50" @click="viewDetail(product.id)" :disabled="isLoadingitem === product.id">詳細介紹</button>
                        <button type="button" class="bg-blue-500  text-white focus:ring-4 focus:ring-gray-300 rounded border border-gray-200 text-sm font-bold px-4 py-2 focus:z-10  hover:bg-blue-600 disabled:opacity-50" @click="addtoCart(product.id)" :disabled="isLoadingitem === product.id">加入購物車</button>
                    </div>
                </div>
            </li>
        </ul>
        
        <product-detail ref="detailModal" :id="productID"></product-detail>
        <loading v-model:active="isLoading"></loading>
        <template v-if="cartList.carts">
            <div class="bg-gray-100 pt-16">
                <table class="w-3/5 max-w-screen-xl mx-auto">
                    <thead>
                        <tr class="border-t border-b">
                            <th class="w-1/12 text-center py-3"></th>
                            <th class="w-7/12 text-center py-3">品名</th>
                            <th class="w-2/12 text-center py-3">數量</th>
                            <th class="w-1/12 text-center py-3">單位</th>
                            <th class="w-1/12 text-center py-3">單價</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b" v-for="item in cartList.carts">
                            <td class="w-1/12 text-center py-3">
                                <button @click="deleteCartitem(item.id)" type="button" class="w-8 h-8 rounded-full border border-red-700 text-red-700 hover:bg-red-700 hover:text-white">×</button></td>
                            <td class="w-7/12 text-center py-3 flex items-center ">
                                <div class="w-28 h-28 ml-2 mr-8 bg-cover rounded" :style="{ backgroundImage:`url( ${item.product.imageUrl} )` }"></div>
                                <p>{{ item.product.title }}</p></td>
                            <td class="w-2/12 text-center py-3"><input type="number" v-model="item.qty"></td>
                            <td class="w-1/12 text-center py-3">{{ item.product.unit }}</td>
                            <td class="w-1/12 text-center py-3">{{ item.product.price }}</td>
                    </tbody>
                </table>
            </div>
        </template>
        
    </div>
    
</body>


<script type="module">
    // import { createApp } from 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.26/vue.esm-browser.min.js';
    import  productDetail  from './product-detail.js';

    const app = Vue.createApp({
        data(){
            return{
                apiUrl : 'https://vue3-course-api.hexschool.io/v2' ,
                apiPath : 'nd5726-hexschool',
                tempProduct:[],
                productList : [],
                productID : '',
                isLoading :false,
                cartList:[],
                isLoadingitem : '',
            }
        },
        methods :{
            getProduct(){
                axios.get(`${this.apiUrl}/api/${this.apiPath}/products/all`)
                .then((res)=>{
                    this.productList = res.data.products;
                })
                .catch((err)=>{
                })
            },
            viewDetail(id){
                this.productID = id ;
                this.isLoading = true ;
                setTimeout(()=>{
                    this.$refs.detailModal.open_detail = true ;
                    this.isLoading = false ;
                },1000)
            },
            getCart(){
                axios.get(`${this.apiUrl}/api/${this.apiPath}/cart`)
                .then((res)=>{
                    this.cartList = res.data.data;
                })
                .catch((err)=>{
                    
                })
            },
            addtoCart(id,qty = 1){
                this.isLoadingitem = id ;
                this.isLoading = true ;
                const data = {
                    product_id :id,
                    qty
                };
                axios.post(`${this.apiUrl}/api/${this.apiPath}/cart` , { data } )
                .then((res)=>{
                    this.isLoadingitem = '';
                    this.isLoading = false ;
                    this.getCart();
                })
                .catch((err)=>{
                    console.dir(err);
                })
            },
            deleteCartitem(id){
                axios.delete(`${this.apiUrl}/api/${this.apiPath}/cart/${id}`)
                .then((res)=>{
                    this.getCart();
                    console.log(res);
                })
                .catch((err)=>{
                    console.dir(err);
                })
            }
        },
        mounted(){
            this.getProduct();
            this.getCart();
        }
    })
    app.component('productDetail', productDetail );
    app.component('loading', VueLoading.Component)
    app.mount('#app');

</script>


</html>